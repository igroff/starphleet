#!/usr/bin/env bash
### Usage:
###    install
### --help
###
### This will get starphleet on a base machine
source overlay/usr/bin/tools

run_as_root_or_die

#flush out caches, I know, I know -- but really if you don't do this
#Linux would rather swap than let go
sync && echo 3 > /proc/sys/vm/drop_caches

ec2_mounts

#put in the system overlay, gets all the files in place
#for the starphleet jobs
# first remove any old upstart scripts
rm -f /etc/init/starphleet*
# then link everything back to here
for overlay_file in $(find overlay/); do
  final_location=${overlay_file#overlay};
  # skip directories, we'll create them as part of the file (paths) that are 
  # contained within them
  [ -d ${overlay_file} ] && continue
  rm -rf ${final_location}
  mkdir -p $(dirname ${final_location});
  cp $(pwd)/${overlay_file} ${final_location};
done

#source again, yep -- now the environment is in place
source overlay/usr/bin/tools

#starphleet lives here
mkdir -p ${STARPHLEET_TMP}
mkdir -p ${STARPHLEET_ROOT}/diagnostic
chmod -R 755 ${STARPHLEET_ROOT}

#make a place for keys
mkdir -p ${PRIVATE_KEYS}
chmod 755 ${PRIVATE_KEYS}
mkdir -p ${PUBLIC_KEYS}
chmod 755 ${PUBLIC_KEYS}

#force install private and public keys from local vagrant image
if find /starphleet/private_keys/* > /dev/null ; then
  [ -d "${PRIVATE_KEYS}" ] && cp /starphleet/private_keys/* "${PRIVATE_KEYS}"
fi
if find /starphleet/public_keys/* > /dev/null ; then
  [ -d "${PUBLIC_KEYS}" ] && cp /starphleet/public_keys/* "${PUBLIC_KEYS}"
fi

#this is a provisioning script for the base system/host/vm
#run as root, with the starphleet source tree at /starphleet

starphleet-buildpacks

#making base containers as needed, base container serves as the source for
#and we clone the service container on top, the idea is the base container
#can be re-used and thus improve build time
starphleet-build-base-container

starphleet-cleanup
start starphleet
announce *Welcome to Starphleet*
